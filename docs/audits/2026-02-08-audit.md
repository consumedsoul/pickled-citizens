# Weekly Audit - 2026-02-08

**Auditor:** Claude Code
**Files Scanned:** ~30 source files + configs + schema
**Last Audit:** Initial audit

## Summary

- Critical Issues: 2
- High Priority: 5
- Medium Priority: 6
- Low Priority: 5

**Total Action Items:** 18

---

## Critical Issues (Fix Immediately)

### 1. Test/Debug API Endpoint Exposed in Production

**File:** `app/api/test-session/[id]/route.ts`
**Lines:** 1-49
**Risk:** Information disclosure. This endpoint returns raw database rows, service role key existence, and debug info to any caller without authentication.

**Current Code:**
```typescript
return NextResponse.json({
  serviceRoleKeyExists: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
  anySessionCount: anySession?.length || 0,
  anySessions: anySession,
  specificSessionError: sessionError,
  specificSessionData: sessionRow,
  sessionId: sessionId
});
```

**Recommended Fix:** Delete this file entirely. It's a debugging endpoint that should never be in production. It exposes whether the service role key exists, returns raw session data without authentication, and leaks internal error objects.

**Why:** Unauthenticated information disclosure. Attackers can enumerate session data and confirm service key configuration.

---

### 2. Duplicate RLS Policies May Cause Conflicts

**File:** `supabase/schema.sql`
**Lines:** 143-521
**Risk:** The schema defines two sets of RLS policies for multiple tables (e.g., `leagues`, `league_members`, `matches`, etc.). The first set uses `for all` policies, and then a second set defines separate `for select/insert/update/delete` policies. This creates duplicate/conflicting policies that may cause unexpected authorization behavior.

**Example for `leagues` table:**
- Lines 158-165: `leagues_read_authenticated` (select) + `leagues_write_owner` (all)
- Lines 324-336: `leagues_select_all_authenticated` (select) + `leagues_manage_owner` (insert) + `leagues_update_owner` (update) + `leagues_delete_owner` (delete)

**Recommended Fix:** Consolidate to a single set of RLS policies per table. Remove the duplicate `for all` policies (lines 143-321) and keep only the granular per-operation policies (lines 323-521), which are more explicit and easier to reason about.

**Why:** Duplicate policies can create OR conditions that inadvertently widen access. The `for all` policy on `leagues_write_owner` combined with `leagues_manage_owner` could allow unintended operations.

---

## High Priority (This Week)

### 3. OG Image Route Vulnerable to Content Injection

**File:** `app/api/og/route.tsx`
**Lines:** 9-10
**Risk:** XSS/content injection via URL parameters rendered directly into the OG image.

**Current Code:**
```typescript
const title = searchParams.get('title') || 'Pickled Citizens';
const description = searchParams.get('description') || 'Pickleball Team Battle Management Tool';
```

These user-controlled values are rendered directly into JSX. While `ImageResponse` renders to an image (not HTML), the error path at line 92 returns the error message as plain text which could include reflected content.

**Recommended Fix:** Sanitize/truncate `title` and `description` parameters. Add length limits (e.g., 200 chars max) and strip HTML entities.

---

### 4. Excessive `any` Type Usage Throughout Codebase

**File:** Multiple files
**Risk:** Type safety gaps that can hide runtime bugs.

**Key locations:**
- `app/page.tsx:133,161,167,168,233,237,254,279,285,286,337,342` - 12 `any` casts
- `app/profile/page.tsx:105` - `any[]` cast
- `app/admin/events/AdminEventsClient.tsx:13` - `payload: any`
- `app/api/session/[id]/metadata/route.ts:31` - `error: any`
- `app/api/og/route.tsx:90` - `e: any`

**Recommended Fix:** Define proper TypeScript interfaces for Supabase query results. Supabase's `supabase-js` v2 supports generated types. Consider running `supabase gen types typescript` and using typed queries.

---

### 5. `supabaseServiceRole` Silently Falls Back to Anon Client

**File:** `src/lib/supabaseClient.ts`
**Lines:** 23-31
**Risk:** If `SUPABASE_SERVICE_ROLE_KEY` is missing, the service role client silently falls back to the regular anon client. API routes using `supabaseServiceRole` would then operate under RLS restrictions instead of bypassing them, leading to confusing 403/empty-result bugs rather than a clear failure.

**Current Code:**
```typescript
export const supabaseServiceRole: SupabaseClient =
  supabaseUrl && process.env.SUPABASE_SERVICE_ROLE_KEY
    ? createClient(supabaseUrl, process.env.SUPABASE_SERVICE_ROLE_KEY, { ... })
    : supabase; // Fallback to regular client if service role key not available
```

**Recommended Fix:** Use the same `missingClient` proxy pattern (or throw an error) for the service role client so misconfiguration is caught immediately rather than causing silent failures.

---

### 6. Leave League API Doesn't Enforce Sole-Admin Protection

**File:** `app/api/leagues/leave/route.ts`
**Lines:** 39-44
**Risk:** The API directly deletes the league_members row without checking if the user is the sole admin of the league. This bypasses the "sole-admin protection" documented in CLAUDE.md.

**Current Code:**
```typescript
const { data: deletedRows, error: deleteError } = await supabaseServiceRole
  .from('league_members')
  .delete()
  .eq('league_id', leagueId)
  .eq('user_id', userId)
  .select('league_id');
```

**Recommended Fix:** Before deleting, query admin count for the league. If the user is the only admin, return a 409 error explaining they must promote another admin first.

---

### 7. Missing `.env.example` File

**Risk:** New developers have no reference for required environment variables.

**Recommended Fix:** Create `.env.example` with:
```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
NEXT_PUBLIC_SITE_URL=
SUPABASE_SERVICE_ROLE_KEY=
```

---

## Medium Priority (Next Sprint)

### 8. No ESLint Configuration File

**Risk:** The project has `eslint` and `eslint-config-next` as devDependencies but no `.eslintrc.*` or `eslint.config.*` file. `npm run lint` uses Next.js defaults, which may miss important rules.

**Recommended Fix:** Add `.eslintrc.json` extending `next/core-web-vitals` with additional rules for `@typescript-eslint/no-explicit-any`.

---

### 9. `wrangler.worker.toml` Missing Environment Variables

**File:** `wrangler.worker.toml`
**Lines:** 1-8
**Risk:** Unlike `wrangler.toml`, the Worker deploy config doesn't include `[vars]` for `NEXT_PUBLIC_*` variables. These are set via `--keep-vars` in the deploy command, but if a fresh deploy occurs without prior vars, it will break.

**Recommended Fix:** Add `[vars]` section to `wrangler.worker.toml` matching `wrangler.toml`, or document that vars must be pre-set in Cloudflare dashboard.

---

### 10. Client-Side Admin Check Is Bypassable

**File:** `src/components/AdminFooterLinks.tsx:38`, `app/leagues/[id]/page.tsx:67`
**Risk:** Admin status is checked client-side by comparing email strings. While RLS protects the database, the admin pages themselves (`/admin/*`) have no server-side route protection. Anyone can navigate to `/admin/events` and see the page structure (though data queries would fail due to RLS).

**Recommended Fix:** Add middleware or layout-level auth checks for `/admin/*` routes that redirect non-admin users server-side.

---

### 11. `Metadata` Import Unused in Client Component

**File:** `app/sessions/[id]/page.tsx`
**Line:** 6
**Risk:** Minor code quality issue. `Metadata` type is imported from `next` but unused in a `'use client'` component (metadata generation happens in the layout, not this page).

```typescript
import { Metadata } from 'next';
```

**Recommended Fix:** Remove the unused import.

---

### 12. Missing Database Indexes for Performance

**File:** `supabase/schema.sql`
**Risk:** No explicit indexes beyond primary keys. As data grows, these queries will slow down:

- `league_members` queried by `user_id` (profile page, home page) - no index on `user_id`
- `match_players` queried by `user_id` (stats calculation) - no index on `user_id`
- `game_sessions` queried by `league_id` and `scheduled_for` - no composite index
- `matches` queried by `session_id` - no index (though FK may auto-create one)

**Recommended Fix:** Add indexes:
```sql
CREATE INDEX idx_league_members_user_id ON league_members(user_id);
CREATE INDEX idx_match_players_user_id ON match_players(user_id);
CREATE INDEX idx_game_sessions_league_scheduled ON game_sessions(league_id, scheduled_for);
```

---

### 13. TODO Comment for Disabled Feature

**File:** `app/profile/page.tsx`
**Line:** 390

```typescript
// TODO: Temporarily disabled - need to run admin function migration
```

**Risk:** Account deletion functionality may be partially broken. This TODO suggests the `admin_delete_user` function migration hasn't been applied, which could mean users can't fully delete their accounts.

**Recommended Fix:** Verify the migration has been applied in production. If so, remove the TODO. If not, apply it and re-enable the feature.

---

## Low Priority (Backlog)

### 14. `.DS_Store` Files in Git

**Files:** `.DS_Store`, `app/.DS_Store`, `src/.DS_Store`
**Risk:** macOS metadata files polluting the repository.

**Recommended Fix:** Add `**/.DS_Store` to `.gitignore` and remove tracked files:
```bash
git rm --cached .DS_Store app/.DS_Store src/.DS_Store
```

---

### 15. Excessive Console Logging in API Routes

**Files:** `app/api/test-session/[id]/route.ts`, `app/api/session/[id]/metadata/route.ts`
**Risk:** Sensitive data (session IDs, error objects) logged to console in production. While Cloudflare Workers logs are ephemeral, it's still noisy.

**Recommended Fix:** Remove debug `console.log` statements from production API routes. Keep `console.error` for genuine errors only.

---

### 16. `history/page.tsx` Returns 404

**File:** `app/history/page.tsx`
**Risk:** The route exists but returns a "not found" page. This is confusing if users navigate to `/history`.

**Recommended Fix:** Either implement the history page or remove the file. If sessions page already shows history, redirect `/history` to `/sessions`.

---

### 17. Logo Image Sizes Are Large

**Files:** `public/images/Pickled-Citizens-Logo-Site.png` (37KB), `public/images/Pickled-Citizens-Logo-Social.png` (20KB)
**Risk:** Minor performance impact. The site logo could be optimized or converted to WebP/SVG.

**Recommended Fix:** Compress images or convert to modern formats. Consider using Next.js `<Image>` component with optimization.

---

### 18. `share-test/page.tsx` Should Not Be in Production

**File:** `app/share-test/page.tsx`
**Risk:** Test page accessible in production. Low severity since it only displays test content.

**Recommended Fix:** Remove or gate behind admin check.

---

## Action Checklist

- [ ] **CRITICAL:** Delete `app/api/test-session/[id]/route.ts` - debug endpoint in production
- [ ] **CRITICAL:** Consolidate duplicate RLS policies in `supabase/schema.sql`
- [ ] Sanitize OG image route parameters (`app/api/og/route.tsx:9-10`)
- [ ] Replace `any` types with proper interfaces across `app/page.tsx` and other files
- [ ] Make `supabaseServiceRole` throw on missing key (`src/lib/supabaseClient.ts:23-31`)
- [ ] Add sole-admin check to leave league API (`app/api/leagues/leave/route.ts`)
- [ ] Create `.env.example` file
- [ ] Add `.eslintrc.json` configuration
- [ ] Add `[vars]` to `wrangler.worker.toml`
- [ ] Add server-side admin route protection for `/admin/*`
- [ ] Remove unused `Metadata` import (`app/sessions/[id]/page.tsx:6`)
- [ ] Add database indexes for `league_members.user_id`, `match_players.user_id`
- [ ] Resolve TODO at `app/profile/page.tsx:390`
- [ ] Add `.DS_Store` to `.gitignore` and remove tracked files
- [ ] Clean up console.log statements in API routes
- [ ] Remove or redirect `app/history/page.tsx`
- [ ] Optimize logo images
- [ ] Remove `app/share-test/page.tsx` from production

## Trends Since Last Audit

This is the initial audit. Future audits will compare metrics against this baseline.

**Baseline Metrics:**
- Total source files: ~30
- Total lines of code: ~3,500 (estimated)
- `any` type occurrences: 15+
- Console.log in production: 18 occurrences
- TODO/FIXME comments: 1
- Test coverage: 0% (no test files found)
- Dependencies: 3 production, 10 dev

## Recommendations for Next Audit

1. **Testing:** No test files exist. Prioritize adding tests for critical paths (team generation algorithm, leave league API, auth flows).
2. **Type Safety:** Track `any` count reduction after TypeScript types are generated from Supabase schema.
3. **Performance:** Monitor Supabase query performance as data grows. Consider adding database indexes proactively.
4. **Security:** After RLS policy consolidation, verify all access patterns with a test matrix.
5. **Monitoring:** Add error tracking (Sentry or similar) for production error visibility.
