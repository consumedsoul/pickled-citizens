# Weekly Audit - 2026-02-14

**Auditor:** Claude Code
**Duration:** ~45 minutes
**Files Scanned:** 25 source files + configs + schema
**Last Audit:** [2026-02-08](./2026-02-08-audit.md) (6 days ago)

## Summary

- üî¥ Critical Issues: 0
- üü† High Priority: 3
- üü° Medium Priority: 9
- ‚ö™ Low Priority: 6

**Total Action Items:** 18

---

## üéâ Improvements Since Last Audit

### ‚úÖ Critical Issues Fixed (2/2)

1. **‚úÖ FIXED: Test/Debug API Endpoint Removed**
   - `app/api/test-session/[id]/route.ts` has been deleted ‚úì
   - Production no longer exposes debug information

2. **‚úÖ FIXED: Duplicate RLS Policies Consolidated**
   - `supabase/schema.sql` now has single, granular policies per table ‚úì
   - Eliminated conflicting `for all` policies
   - Access control is now clear and predictable

### ‚úÖ High Priority Issues Fixed (3/5)

3. **‚úÖ FIXED: OG Image Route Now Sanitized**
   - Added `sanitizeParam()` function with HTML stripping and length limits ‚úì
   - Title limited to 100 chars, description to 200 chars

4. **‚úÖ FIXED: Service Role Client Error Handling**
   - `src/lib/supabaseClient.ts` now throws on missing service role key ‚úì
   - Uses Proxy pattern to catch misconfiguration immediately
   - No more silent fallback to anon client

5. **‚úÖ FIXED: Leave League API Has Sole-Admin Protection**
   - `app/api/leagues/leave/route.ts` now checks admin count ‚úì
   - Returns 409 error if user is the only admin
   - Lines 47-62 implement the check

### ‚ö†Ô∏è Not Yet Fixed From Previous Audit

- Excessive `any` type usage (still 19 occurrences in app/page.tsx alone)
- Missing `.env.example` file
- No ESLint configuration file
- Admin route protection (still client-side only, no middleware)
- Missing database indexes
- TODO comment at `app/profile/page.tsx:390`
- `.DS_Store` files still tracked in git
- Console.log cleanup in API routes (mostly done, 2 remain)
- `app/history/page.tsx` still returns 404
- `app/share-test/page.tsx` still in production

---

## üî¥ Critical Issues (Fix Immediately)

**None!** All critical issues from the previous audit have been resolved. üéâ

---

## üü† High Priority (This Week)

### 1. Missing `.env.example` File

**Risk:** New developers and deployment pipelines have no reference for required environment variables. The README.md mentions `.env.local` but doesn't provide a template.

**Current State:** No `.env.example` file exists in the repository.

**Recommended Fix:**
Create `.env.example` with:
```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here

# Site Configuration
NEXT_PUBLIC_SITE_URL=https://pickledcitizens.com

# Server-side only (never commit actual value)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
```

**Why:** Industry best practice. Prevents misconfiguration during setup and deployment.

---

### 2. No ESLint Configuration File

**Risk:** The project has `eslint` and `eslint-config-next` as devDependencies but no `.eslintrc.*` or `eslint.config.*` file. Running `npm run lint` uses Next.js defaults only, which won't catch common issues like excessive `any` types.

**Current State:** No ESLint config file exists. Default Next.js rules are minimal.

**Recommended Fix:**
Create `.eslintrc.json`:
```json
{
  "extends": ["next/core-web-vitals"],
  "rules": {
    "@typescript-eslint/no-explicit-any": "warn",
    "@typescript-eslint/no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }],
    "no-console": ["warn", { "allow": ["error"] }]
  }
}
```

**Why:** Will surface the 19+ `any` types as warnings and help prevent new ones. Will also catch unused variables and excessive console logging.

---

### 3. Missing Database Indexes for Performance

**File:** `supabase/schema.sql`
**Risk:** As data grows, queries will slow down significantly. Foreign key lookups and filtered queries lack indexes.

**Missing Indexes:**
- `league_members(user_id)` - queried on home page, profile page, session creation
- `match_players(user_id)` - queried for lifetime stats calculation
- `game_sessions(league_id, scheduled_for)` - composite index for session lists
- `matches(session_id)` - queried for match display (FK may auto-create, but not guaranteed)

**Recommended Fix:**
Add migration file `supabase/migrations/YYYYMMDDHHMMSS_add_performance_indexes.sql`:
```sql
-- Index for league members by user (home page, profile queries)
CREATE INDEX IF NOT EXISTS idx_league_members_user_id ON league_members(user_id);

-- Index for match players by user (stats calculation)
CREATE INDEX IF NOT EXISTS idx_match_players_user_id ON match_players(user_id);

-- Composite index for session listing by league and date
CREATE INDEX IF NOT EXISTS idx_game_sessions_league_scheduled ON game_sessions(league_id, scheduled_for DESC);

-- Index for matches by session (session detail page)
CREATE INDEX IF NOT EXISTS idx_matches_session_id ON matches(session_id);

-- Index for match results (stats queries)
CREATE INDEX IF NOT EXISTS idx_match_results_match_id ON match_results(match_id);
```

**Why:** These queries will be hit on every page load. Without indexes, full table scans will occur as data grows beyond ~1000 rows.

---

## üü° Medium Priority (Next Sprint)

### 4. Excessive `any` Type Usage (Still High)

**Files:** `app/page.tsx` (19 occurrences), `app/profile/page.tsx`, `app/admin/events/AdminEventsClient.tsx`, API routes

**Current State:** Still widespread use of `any` types throughout the codebase.

**Example from `app/page.tsx:133`:**
```typescript
const memberships = (membershipData as any[]) || [];
```

**Recommended Fix:**
Generate TypeScript types from Supabase schema:
```bash
npx supabase gen types typescript --project-id alyqhhyvpebvmdcssahn > src/types/supabase.ts
```

Then use typed queries:
```typescript
import { Database } from '@/types/supabase';

type LeagueMember = Database['public']['Tables']['league_members']['Row'];

const { data: memberships } = await supabase
  .from('league_members')
  .select('league_id, role')
  .eq('user_id', userId)
  .returns<LeagueMember[]>();
```

**Why:** Type safety prevents runtime errors and improves developer experience with autocomplete.

---

### 5. Admin Route Protection is Client-Side Only

**Files:** `src/components/AdminFooterLinks.tsx:38`, `/admin/*` routes
**Risk:** While RLS protects data, the admin pages themselves have no server-side route protection. Anyone can navigate to `/admin/events` and see the page structure (though queries fail due to RLS).

**Current Protection:** Client-side email check only
```typescript
const isAdmin = email === 'hun@ghkim.com';
```

**Recommended Fix:**
Create `app/admin/middleware.ts`:
```typescript
import { NextResponse } from 'next/server';
import { supabase } from '@/lib/supabaseClient';

export async function middleware(request: Request) {
  const { data } = await supabase.auth.getUser();
  const email = data.user?.email?.toLowerCase();

  if (email !== 'hun@ghkim.com') {
    return NextResponse.redirect(new URL('/', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: '/admin/:path*'
};
```

**Why:** Defense in depth. Server-side protection prevents unauthorized users from even seeing admin UI structure.

---

### 6. Unused `Metadata` Import in Client Component

**File:** `app/sessions/[id]/page.tsx:6`
**Risk:** Minor code quality issue. Dead import clutters the file.

```typescript
import { Metadata } from 'next';
```

This import is unused because:
1. The component is marked `'use client'`
2. Metadata generation happens in layouts, not client components

**Recommended Fix:** Remove the import.

---

### 7. wrangler.worker.toml Missing Environment Variables

**File:** `wrangler.worker.toml`
**Risk:** Unlike `wrangler.toml`, the Worker config doesn't include `[vars]`. Relies entirely on `--keep-vars` flag, which assumes vars are already set in Cloudflare dashboard.

**Current State:**
```toml
name = "pickled-citizens"
main = ".open-next/worker.js"
compatibility_date = "2025-12-14"
compatibility_flags = ["nodejs_compat"]

[assets]
directory = ".open-next/assets"
binding = "ASSETS"
```

**Recommended Fix:**
Add vars section:
```toml
[vars]
NEXT_PUBLIC_SITE_URL = "https://pickledcitizens.com"
NEXT_PUBLIC_SUPABASE_URL = "https://alyqhhyvpebvmdcssahn.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "sb_publishable_c6B_tg9PKslCicc4Y1Cz0A_CqnUJ_P8"
```

**Why:** Ensures vars are always present in fresh deploys. `--keep-vars` is fragile if Cloudflare dashboard state changes.

---

### 8. TODO Comment for Disabled Feature

**File:** `app/profile/page.tsx:390`

```typescript
// TODO: Temporarily disabled - need to run admin function migration
```

**Risk:** Account deletion functionality may be partially broken. This TODO suggests the `admin_delete_user` function migration hasn't been applied.

**Investigation Needed:**
1. Check if `admin_delete_user` function exists in production Supabase
2. If yes, remove TODO and re-enable feature
3. If no, apply the migration from `supabase/schema.sql` lines 126-141

**Current State:** The function IS defined in `schema.sql`, so this TODO is likely stale.

**Recommended Fix:** Verify function exists in production, then remove the TODO comment.

---

### 9. `.DS_Store` Files Tracked in Git

**Files:** `.DS_Store`, `app/.DS_Store`, `app/images/.DS_Store`, `src/.DS_Store` (14 total including node_modules)

**Risk:** macOS metadata files pollute repository history and show up in diffs.

**Current `.gitignore`:** Does not include `.DS_Store` pattern.

**Recommended Fix:**
```bash
# Add to .gitignore
echo "**/.DS_Store" >> .gitignore

# Remove from git tracking
git rm --cached .DS_Store app/.DS_Store app/images/.DS_Store src/.DS_Store

# Commit
git add .gitignore
git commit -m "Add .DS_Store to gitignore and remove tracked files"
```

**Why:** Standard best practice for macOS development. Prevents repository pollution.

---

### 10. Console Logging in Production API Routes

**Files:** `app/api/session/[id]/metadata/route.ts:34-36`

**Current Code:**
```typescript
console.error('Session fetch error:', sessionError);
console.error('Session ID being queried:', sessionId);
console.error('Using service role:', !!process.env.SUPABASE_SERVICE_ROLE_KEY);
```

**Risk:**
- Logs service role key existence to Cloudflare Workers logs
- Potentially leaks session IDs in error logs
- Line 36 is debugging info that shouldn't be in production

**Recommended Fix:**
Keep only the first error log:
```typescript
if (sessionError || !sessionRow) {
  console.error('Session fetch error:', sessionError?.message || 'Session not found');
  return NextResponse.json({ error: 'Session not found' }, { status: 404 });
}
```

**Why:** Reduce log noise and avoid leaking implementation details.

---

### 11. No Server-Side Middleware for Global Route Protection

**Risk:** While specific routes like `/profile` check auth client-side, there's no global middleware to enforce authentication or handle redirects consistently.

**Current State:** Each page handles auth independently, leading to code duplication.

**Recommended Fix:**
Consider adding `middleware.ts` at root level for:
- Automatic redirect to `/auth` for unauthenticated users on protected routes
- Consistent token refresh handling
- Centralized auth state management

**Why:** Centralized auth logic reduces duplication and ensures consistent behavior.

---

### 12. Outdated Dependencies

**Risk:** Using older versions of dependencies may miss security patches, bug fixes, and performance improvements.

**Current vs Latest:**
- `@opennextjs/cloudflare`: 1.14.6 ‚Üí 1.16.5 (minor update available)
- `@supabase/supabase-js`: 2.81.1 ‚Üí 2.95.3 (14 minor versions behind)
- `wrangler`: 4.54.0 ‚Üí 4.65.0
- Major version updates available but risky:
  - `next`: 14.2.35 ‚Üí 16.1.6 (major version jump)
  - `react`: 18.3.1 ‚Üí 19.2.4 (major version jump)
  - `tailwindcss`: 3.4.19 ‚Üí 4.1.18 (major version jump)

**Recommended Fix:**
Safe updates (same major version):
```bash
npm update @opennextjs/cloudflare @supabase/supabase-js wrangler
```

Major version updates require testing and migration:
- Next.js 15+ requires App Router changes
- React 19 introduces new features but has breaking changes
- Tailwind 4 has major config changes

**Why:** Stay current with security patches. Major updates should be planned separately.

---

## ‚ö™ Low Priority (Backlog)

### 13. `app/history/page.tsx` Returns 404

**File:** `app/history/page.tsx`

**Current Code:**
```typescript
import { notFound } from 'next/navigation';

export default function HistoryPage() {
  notFound();
}
```

**Risk:** The route exists but intentionally returns 404. Confusing if users navigate to `/history`.

**Recommended Fix:**
- Either implement the history page (showing all sessions)
- Or remove the file entirely
- Or redirect to `/sessions` if they're equivalent

**Why:** Dead routes create confusion. README.md mentions this page but it's not functional.

---

### 14. `app/share-test/page.tsx` Should Not Be in Production

**Risk:** Test page accessible in production at `/share-test`. Low severity since it only displays test Open Graph metadata.

**Recommended Fix:**
- Remove the file entirely
- Or gate behind admin check
- Or move to a dev-only route

**Why:** Test pages shouldn't ship to production.

---

### 15. Logo Images Could Be Optimized

**Files:**
- `public/images/Pickled-Citizens-Logo-Site.png` (38KB)
- `public/images/Pickled-Citizens-Logo-Social.png` (21KB)

**Risk:** Minor performance impact. Images could be compressed or converted to WebP/AVIF.

**Recommended Fix:**
```bash
# Convert to WebP for ~40% size reduction
npx @squoosh/cli --webp auto public/images/*.png
```

Or use Next.js `<Image>` component with automatic optimization.

**Why:** Faster page loads, especially on mobile. Modern formats like WebP have better compression.

---

### 16. No Test Coverage

**Risk:** Critical business logic is untested. Changes risk breaking functionality.

**Current State:** Zero test files exist in the repository.

**High-Risk Areas Without Tests:**
- Team generation algorithm (snaking, 8-player format)
- Leave league API (sole-admin check)
- Auth flows (magic link, profile completion)
- RLS policies (access control)

**Recommended Fix:**
Add Vitest or Jest:
```bash
npm install -D vitest @vitejs/plugin-react
```

Start with:
1. Unit tests for pure functions (team generation)
2. Integration tests for API routes
3. E2E tests for critical user flows

**Why:** Regression prevention. Confidence when refactoring.

---

### 17. Missing Accessibility Attributes

**Risk:** Screen reader users and keyboard navigation may be degraded.

**Findings:**
- Only 2 files use `alt` attributes for images
- No ARIA labels on interactive elements
- Focus indicators may be insufficient
- Form labels may not be properly associated

**Recommended Fix:**
- Audit with Lighthouse accessibility checker
- Add `alt` text to all images
- Add ARIA labels to icon buttons
- Ensure keyboard navigation works throughout
- Test with screen reader (VoiceOver on macOS)

**Why:** Legal compliance (ADA, Section 508) and inclusive design.

---

### 18. No Error Tracking or Monitoring

**Risk:** Production errors go unnoticed until users report them.

**Current State:** Only console.error logging exists. No aggregation or alerting.

**Recommended Fix:**
Add Sentry or similar:
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

Configure for Cloudflare Workers environment.

**Why:** Proactive error detection. Understand what's breaking in production before users report it.

---

## üìã Action Checklist

### High Priority (This Week)
- [ ] Create `.env.example` file with all required environment variables
- [ ] Add `.eslintrc.json` configuration with TypeScript rules
- [ ] Add database indexes migration (`league_members.user_id`, `match_players.user_id`, composite indexes)

### Medium Priority (Next Sprint)
- [ ] Generate TypeScript types from Supabase schema
- [ ] Replace `any` types with proper interfaces (start with `app/page.tsx`)
- [ ] Add admin middleware for server-side route protection (`app/admin/middleware.ts`)
- [ ] Remove unused `Metadata` import from `app/sessions/[id]/page.tsx:6`
- [ ] Add `[vars]` section to `wrangler.worker.toml`
- [ ] Verify `admin_delete_user` function exists, remove TODO at `app/profile/page.tsx:390`
- [ ] Add `.DS_Store` to `.gitignore` and remove tracked files
- [ ] Clean up console.log in `app/api/session/[id]/metadata/route.ts`
- [ ] Consider adding root-level `middleware.ts` for global auth handling
- [ ] Update safe dependencies (`@opennextjs/cloudflare`, `@supabase/supabase-js`, `wrangler`)

### Low Priority (Backlog)
- [ ] Implement or remove `app/history/page.tsx`
- [ ] Remove `app/share-test/page.tsx` from production
- [ ] Optimize logo images (convert to WebP)
- [ ] Add test suite (start with unit tests for team generation)
- [ ] Accessibility audit with Lighthouse
- [ ] Add error tracking (Sentry or similar)

---

## üìä Trends Since Last Audit (2026-02-08)

### ‚úÖ Improvements
- **Critical issues resolved:** 2 ‚Üí 0 (-100%)
- **High priority issues:** 5 ‚Üí 3 (-40%)
- **Security:** Major improvements in RLS policies and service role handling
- **Code quality:** Better error handling, input sanitization

### ‚ö†Ô∏è Concerns
- **`any` types:** Still 19+ occurrences (no improvement)
- **Test coverage:** Still 0% (no change)
- **Dev tooling:** No progress on ESLint config or .env.example

### üìà Metrics
| Metric | 2026-02-08 | 2026-02-14 | Change |
|--------|------------|------------|--------|
| Critical Issues | 2 | 0 | ‚úÖ -100% |
| High Priority | 5 | 3 | ‚úÖ -40% |
| Medium Priority | 6 | 9 | ‚ö†Ô∏è +50% |
| Low Priority | 5 | 6 | ‚û°Ô∏è +20% |
| Total Files | ~30 | 25 | ‚û°Ô∏è |
| Lines of Code | ~3,500 | ~3,605 | ‚û°Ô∏è |
| `any` types | 15+ | 19+ | ‚ùå +27% |
| Console.log | 18 | 2 | ‚úÖ -89% |
| Test coverage | 0% | 0% | ‚û°Ô∏è |

**Overall Trend:** üü¢ Improving
- Security and critical issues addressed quickly
- Medium priority count increased due to better detection (not new issues)
- Type safety and testing remain long-term debt

---

## üéØ Recommendations for Next Audit (2026-02-21)

1. **Focus on Type Safety:**
   - Track progress on reducing `any` types
   - Generate Supabase TypeScript types
   - Set ESLint rules to enforce typing

2. **Developer Experience:**
   - Verify `.env.example` and ESLint config are added
   - Check if new developers can onboard smoothly

3. **Performance Monitoring:**
   - After database indexes are added, compare query performance
   - Measure page load times with indexes vs without

4. **Security Hardening:**
   - Verify admin middleware is implemented
   - Test auth flows for edge cases
   - Review any new API endpoints

5. **Dependency Management:**
   - Check if safe updates were applied
   - Plan for major version upgrades (Next.js 15+, React 19)

---

## üìù Documentation Updates

### README.md
**Status:** ‚úÖ Excellent condition (no changes needed)
**Quality Score:** 9/10

**Strengths:**
- Comprehensive feature list
- Clear setup instructions
- Environment variables documented
- Recent updates section maintained
- Super-admin configuration clearly explained

**Minor Improvement:**
- Could mention `.env.example` once it's created
- Could add "Quick Start" section at top for faster onboarding

### CLAUDE.md
**Status:** ‚úÖ Optimal (no changes needed)
**Line count:** 139 lines (well under 800-line target)
**Quality Score:** 10/10

**Strengths:**
- Concise and focused
- All sections are current and accurate
- Well-organized structure
- No outdated information
- Perfect length for AI context

**No optimizations needed.** CLAUDE.md is exemplary.

---

**Audit completed:** 2026-02-14
**Next audit due:** 2026-02-21
