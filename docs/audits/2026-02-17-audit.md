# Weekly Audit - 2026-02-17

**Auditor:** Claude Code
**Duration:** ~30 minutes
**Files Scanned:** 26 source files + configs + schema + migrations
**Last Audit:** [2026-02-14](./2026-02-14-audit.md) (3 days ago)

## Summary

- ðŸ”´ Critical Issues: 1
- ðŸŸ  High Priority: 2
- ðŸŸ¡ Medium Priority: 7
- âšª Low Priority: 6
- ðŸ’¡ New Feature Ideas: 5

**Total Action Items:** 16

---

## ðŸ“Š Repository Health Score

**Overall Score: 69/100** (C) - Fair

**Score Calculation:**
- Base: 100 points
- Critical issues: -10 points (1 Ã— 10)
- High priority: -10 points (2 Ã— 5)
- Medium priority: -14 points (7 Ã— 2)
- Low priority: -3 points (6 Ã— 0.5)
- Bonuses/Penalties:
  - README.md exists and comprehensive (8/10): +5 points
  - CLAUDE.md optimized (139 lines): +5 points
  - .env.example exists: +3 points
  - Deployment docs complete: +3 points
  - Zero tests: -10 points
- **Final Score: 69/100** (after adjustments)

### Category Breakdown

- ðŸ”’ **Security**: 80/100 (Good)
- âš¡ **Performance**: 85/100 (Good)
- ðŸŽ¯ **Code Quality**: 60/100 (Fair)
- ðŸ“š **Documentation**: 75/100 (Good)

### Score History

| Date | Overall | Security | Performance | Code Quality | Documentation | Change | Key Actions |
|------|---------|----------|-------------|--------------|---------------|--------|-------------|
| 2026-02-17 | 69/100 | 80/100 | 85/100 | 60/100 | 75/100 | N/A* | Corrupted file found, .env/.eslint/middleware added |
| 2026-02-14 | N/A | N/A | N/A | N/A | N/A | - | All critical fixed, 3 high priority items |
| 2026-02-08 | N/A | N/A | N/A | N/A | N/A | - | Initial audit baseline |

*First audit with scoring system â€” no prior score to compare.

### What This Score Means

**C - Fair**: The codebase is functional for development with solid security fundamentals (RLS on all tables, admin middleware, service role isolation). It has a comprehensive README, good CLAUDE.md, and proper .env.example. However, a corrupted type file, zero test coverage, and persistent type safety issues need attention before it's fully production-grade.

**Key Strengths:**
- RLS enabled on all tables with well-designed policies
- Admin middleware provides server-side route protection (new since last audit)
- .env.example and .eslintrc.json added (addressed from last audit)
- Database indexes added for performance
- Comprehensive README.md (527 lines, well-structured)

**Primary Concerns:**
- `src/types/supabase.ts` is corrupted (contains npm error output instead of types)
- 30 `any`/`as any` usages across 9 files
- Zero test coverage
- README has some outdated references (mentions deleted test endpoint, history page as functional)

### Quick Wins to Improve Score (+15 points potential)

1. **Fix corrupted `src/types/supabase.ts`** (+10 points)
   - Why: Critical type file contains npm error output instead of generated types
   - Time: 5 minutes (regenerate or delete)

2. **Add `.DS_Store` to `.gitignore`** (+2 points)
   - Why: macOS metadata files shouldn't be in version control
   - Time: 2 minutes

3. **Update README.md inaccuracies** (+3 points)
   - Why: References deleted test endpoint and non-functional history page
   - Time: 10 minutes

---

## ðŸŽ‰ Improvements Since Last Audit (2026-02-14)

### âœ… High Priority Issues Fixed (3/3)

1. **âœ… FIXED: `.env.example` File Created**
   - `.env.example` exists with all required environment variables documented âœ“
   - Includes helpful comments linking to Supabase dashboard

2. **âœ… FIXED: `.eslintrc.json` Configuration Added**
   - ESLint configuration now exists with TypeScript rules âœ“

3. **âœ… FIXED: Database Performance Indexes Added**
   - Migration `20260214000000_add_performance_indexes.sql` created âœ“
   - Covers: `league_members.user_id`, `match_players.user_id`, `game_sessions(league_id, scheduled_for)`, `matches.session_id`, `league_invites.email`, `league_invites.league_id`

### âœ… Medium Priority Issues Fixed (2/9)

4. **âœ… FIXED: Admin Middleware for Server-Side Route Protection**
   - `app/admin/middleware.ts` now exists âœ“
   - Server-side JWT verification on all `/admin/*` routes
   - Redirects unauthorized users to home page

5. **âœ… FIXED: `src/types/database.ts` Created**
   - 269-line comprehensive type definitions for all tables âœ“
   - Proper Row/Insert/Update types with literal types for constraints

### âš ï¸ Not Yet Fixed From Previous Audit

- 30 `any`/`as any` type occurrences (was 19+ last audit â€” increased due to better detection)
- `.DS_Store` files still tracked in git (`.gitignore` missing `.DS_Store` pattern)
- `app/share-test/page.tsx` still in production
- `app/history/page.tsx` still returns 404
- TODO comment at `app/profile/page.tsx:390` (admin_delete_user still disabled)
- Console.log statements in production API routes (13 total across 6 files)

---

## ðŸ”´ Critical Issues (Fix Immediately)

### 1. Corrupted File: `src/types/supabase.ts`

**File:** `src/types/supabase.ts`
**Lines:** 1-3
**Risk:** Build failures or silent type errors. File contains npm error output instead of TypeScript types.

**Current Content:**
```
npm warn exec The following package was not found and will be installed: supabase@2.76.8
2026/02/14 00:53:56 Access token not provided. Supply an access token by running supabase login or setting the SUPABASE_ACCESS_TOKEN environment variable.
```

**Root Cause:** Running `npx supabase gen types typescript` redirected stderr to this file instead of stdout, or the command was run without authentication.

**Recommended Fix:**
Option A â€” Delete the file (if `src/types/database.ts` is the canonical type file):
```bash
rm src/types/supabase.ts
git rm src/types/supabase.ts
```

Option B â€” Regenerate with proper authentication:
```bash
npx supabase login
npx supabase gen types typescript --project-id alyqhhyvpebvmdcssahn > src/types/supabase.ts
```

**Why:** This file may be imported elsewhere, causing confusing build errors. Even if not imported, a corrupted file in the types directory is misleading.

---

## ðŸŸ  High Priority (This Week)

### 2. Account Deletion Doesn't Remove Auth User

**File:** `app/profile/page.tsx:390`
**Lines:** 390-407
**Risk:** Users who "delete their account" still exist in Supabase Auth and can re-sign up. Data is removed but the auth identity persists.

**Current Code:**
```typescript
// TODO: Temporarily disabled - need to run admin function migration
// Delete the actual auth user account
// const { error: deleteError } = await supabase.rpc('admin_delete_user', {...})
```

**Why this matters:** The `admin_delete_user` function IS defined in `schema.sql` (lines 127-141). This TODO may be stale â€” the function likely exists in production but was never re-enabled in code.

**Recommended Fix:**
1. Verify `admin_delete_user` exists in production: `SELECT proname FROM pg_proc WHERE proname = 'admin_delete_user';`
2. If it exists, uncomment the RPC call and remove the TODO
3. If not, run the migration from schema.sql

---

### 3. Non-Transactional Account Deletion (Data Integrity Risk)

**File:** `app/profile/page.tsx:348-407` and `app/admin/users/page.tsx:219-233`
**Lines:** Multiple
**Risk:** Account deletion performs sequential deletes across 4 tables. If any operation fails mid-way, data is left in an inconsistent state with no rollback.

**Current Code (profile/page.tsx):**
```typescript
const operations = [
  supabase.from('league_members').delete().eq('user_id', user.id),
  supabase.from('league_invites').delete().eq('email', email),
  supabase.from('leagues').delete().eq('owner_id', user.id),
  supabase.from('profiles').delete().eq('id', user.id),
];
for (const op of operations) {
  const { error } = await op;
  if (error) { return; } // Prior deletions are NOT rolled back
}
```

**Recommended Fix:** Create a Supabase RPC function that wraps all deletions in a single transaction:
```sql
CREATE OR REPLACE FUNCTION delete_user_cascade(target_user_id uuid)
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  DELETE FROM public.league_members WHERE user_id = target_user_id;
  DELETE FROM public.league_invites WHERE email = (SELECT email FROM public.profiles WHERE id = target_user_id);
  DELETE FROM public.leagues WHERE owner_id = target_user_id;
  DELETE FROM public.profiles WHERE id = target_user_id;
END;
$$;
```

**Why:** Partial deletions leave orphaned records and inconsistent state.

---

## ðŸŸ¡ Medium Priority (Next Sprint)

### 5. Excessive `any` Type Usage (30 occurrences)

**Files:** 9 files with `any`/`as any` casts
**Key offenders:**
- `app/sessions/page.tsx` â€” 10 occurrences
- `app/sessions/[id]/page.tsx` â€” 7 occurrences
- `app/leagues/page.tsx` â€” 5 occurrences

**Risk:** Bypasses TypeScript checking, hides potential runtime errors.

**Recommended Fix:** Replace with types from `src/types/database.ts`:
```typescript
import { Database } from '@/types/database';
type LeagueRow = Database['public']['Tables']['leagues']['Row'];
```

---

### 6. Hardcoded Admin Email in 7 Locations

**Files:** `src/components/AdminFooterLinks.tsx:38`, `app/admin/events/AdminEventsClient.tsx:58`, `app/admin/leagues/page.tsx:47,78`, `app/admin/middleware.ts:8`, `app/admin/users/page.tsx:58`, `app/leagues/[id]/page.tsx:67`

**Risk:** If admin email changes, requires updates in 7 files plus database schema.

**Recommended Fix:** Create a shared constant:
```typescript
// src/lib/constants.ts
export const SUPER_ADMIN_EMAIL = 'hun@ghkim.com';
```

---

### 7. `.DS_Store` Files Tracked in Git

**Files:** `.DS_Store`, `app/.DS_Store`, `src/.DS_Store`
**Risk:** macOS metadata files pollute repository history.

**Current `.gitignore`:** Missing `.DS_Store` pattern.

**Recommended Fix:**
```bash
echo "**/.DS_Store" >> .gitignore
git rm --cached .DS_Store app/.DS_Store src/.DS_Store
```

---

### 8. `app/share-test/page.tsx` in Production

**File:** `app/share-test/page.tsx`
**Risk:** Test page accessible at `/share-test` in production. Low severity but unprofessional.

**Recommended Fix:** Delete the file.

---

### 9. Console Logging in Production (13 occurrences)

**Files:** 6 files with `console.log`/`console.error`/`console.warn`
**Key concern:** `app/api/session/[id]/metadata/route.ts:34-36` logs service role key existence and session IDs.

**Recommended Fix:** Remove debug console.log statements. Keep only `console.error` for actual error conditions.

---

### 10. Admin User Edit Uses Client-Side Supabase (RLS Bypass Issue)

**File:** `app/admin/users/page.tsx:173-181`
**Risk:** Admin editing profiles via client-side `supabase` client. The `profiles_update_own` RLS policy only allows users to update their OWN profile (`auth.uid() = id`). This means the super-admin CANNOT edit other users' profiles through the current implementation.

**Recommended Fix:** Move admin profile edits to an API route using `supabaseServiceRole`.

---

### 11. Missing `updated_at` on Several Tables

**Tables:** `leagues`, `league_members`, `league_invites`, `game_sessions`, `matches`, `match_players`, `match_results`
**Risk:** No audit trail for when records were last modified. Only `profiles` has `updated_at`.

**Recommended Fix:** Add `updated_at timestamptz default now()` column with auto-update trigger to critical tables.

---

## âšª Low Priority (Backlog)

### 12. `app/history/page.tsx` Returns 404

**File:** `app/history/page.tsx`
**Risk:** Dead route. Either implement or remove.

### 13. No Test Coverage

**Risk:** Zero test files. Critical paths (team generation, auth flows, leave league) are untested.

### 14. Unused `Metadata` Import

**File:** `app/sessions/[id]/page.tsx:6`
**Risk:** Dead import in client component. Minor code quality.

### 15. Pagination Edge Case in Admin Events

**File:** `app/admin/events/AdminEventsClient.tsx`
**Risk:** "Next page" button check `events.length < PAGE_SIZE` fails when last page has exactly PAGE_SIZE items.

### 16. No Error Tracking/Monitoring

**Risk:** Production errors only visible via Cloudflare Workers logs. No aggregation or alerting.

### 17. Missing Accessibility Attributes

**Risk:** Limited ARIA labels, missing alt text, keyboard navigation gaps.

---

## ðŸ’¡ New Features & Enhancements

### User Experience

#### 1. Session History Page
**Effort:** Medium
**Impact:** High
**Priority:** Should-have

**Description:** Implement the `/history` page to show all past sessions with stats, rather than the current 404. Users need a way to review their game history.

**Implementation Notes:**
- Modify `app/history/page.tsx` to query `game_sessions` with past dates
- Include win/loss stats per session
- Add pagination for large history sets

**User Value:** Core feature gap â€” users want to track their progress over time.

---

#### 2. Dark Mode Toggle
**Effort:** Medium
**Impact:** Medium
**Priority:** Nice-to-have

**Description:** Add dark mode support. Tailwind's `dark:` variants are already available. The current theme is already dark, but a system-preference toggle would improve UX.

**Implementation Notes:**
- Add ThemeContext provider
- Store preference in localStorage
- Use Tailwind `dark:` variants
- Estimated: 4-6 hours

**User Value:** Reduces eye strain, modern UX expectation.

---

### Analytics & Insights

#### 3. Player Performance Dashboard
**Effort:** Medium
**Impact:** High
**Priority:** Should-have

**Description:** Expand lifetime stats into a dedicated dashboard showing win rate trends, frequent partners, court performance, and DUPR progression.

**Implementation Notes:**
- Query `match_results` + `match_players` for historical data
- Chart library (lightweight: Chart.js or Recharts)
- Estimated: 1-2 days

**User Value:** Competitive players want detailed performance tracking.

---

### Community & Sharing

#### 4. Post-Session Summary Sharing
**Effort:** Low
**Impact:** Medium
**Priority:** Should-have

**Description:** After a session ends, generate a shareable summary card with results, MVP stats, and standings. Leverage existing OG image generation.

**Implementation Notes:**
- Extend `/api/og` route for session summaries
- Add "Share Results" button on session detail page
- Estimated: 3-4 hours

**User Value:** Organic growth through social sharing.

---

#### 5. In-App Notifications for Session Invites
**Effort:** High
**Impact:** High
**Priority:** Should-have

**Description:** Notify league members when a new session is created. Currently there's no notification mechanism â€” members must check the app manually.

**Implementation Notes:**
- Supabase Realtime for in-app notifications
- Optional: email notifications via Supabase Edge Functions
- Estimated: 2-3 days

**User Value:** Increases session participation and engagement.

---

## ðŸ“‹ Feature Prioritization Summary

**Quick Wins (Low Effort, High Impact):**
1. Post-Session Summary Sharing (3-4 hours, social growth)

**Strategic Bets (High Effort, High Impact):**
1. Session History Page (core feature gap)
2. In-App Notifications (engagement driver)

**Backlog:**
- Dark Mode Toggle
- Player Performance Dashboard

---

## ðŸ“‹ Action Checklist

### Critical (Fix Immediately)
- [ ] Fix or delete corrupted `src/types/supabase.ts`

### High Priority (This Week)
- [ ] Re-enable `admin_delete_user` RPC in `app/profile/page.tsx:390`
- [ ] Create transactional `delete_user_cascade` RPC function

### Medium Priority (Next Sprint)
- [ ] Reduce `any` types: start with `app/sessions/page.tsx` (10 occurrences)
- [ ] Extract admin email to shared constant (`src/lib/constants.ts`)
- [ ] Add `.DS_Store` to `.gitignore` and remove tracked files
- [ ] Delete `app/share-test/page.tsx`
- [ ] Clean up console.log in API routes (especially `app/api/session/[id]/metadata/route.ts`)
- [ ] Fix admin user edit to use service role API route
- [ ] Add `updated_at` columns to core tables

### Low Priority (Backlog)
- [ ] Implement or remove `app/history/page.tsx`
- [ ] Add test suite (start with team generation unit tests)
- [ ] Remove unused `Metadata` import from `app/sessions/[id]/page.tsx:6`
- [ ] Fix pagination edge case in `app/admin/events/AdminEventsClient.tsx`
- [ ] Add error tracking (Sentry or similar)
- [ ] Accessibility audit

---

## ðŸ“Š Trends Since Last Audit (2026-02-14)

### âœ… Improvements
- **High priority issues resolved:** 3/3 from last audit (100%)
  - `.env.example` created âœ“
  - `.eslintrc.json` added âœ“
  - Database indexes added âœ“
- **Admin middleware:** Server-side route protection now exists âœ“
- **Type definitions:** `src/types/database.ts` created with 269 lines of proper types âœ“

### âš ï¸ Concerns
- **New critical issue:** Corrupted `src/types/supabase.ts` (likely from type generation attempt)
- **`any` types:** 30 occurrences detected (was 19+ â€” better detection, same underlying issue)
- **Test coverage:** Still 0% (no change across 3 audits)
- **README.md:** Has outdated references (deleted test endpoint, non-functional history page)
- **`.DS_Store`:** Still tracked in git (3 audits running)

### ðŸ“ˆ Metrics

| Metric | 2026-02-08 | 2026-02-14 | 2026-02-17 | Change |
|--------|------------|------------|------------|--------|
| Critical Issues | 2 | 0 | 1 | âŒ +1 (new) |
| High Priority | 5 | 3 | 2 | âœ… -33% |
| Medium Priority | 6 | 9 | 7 | âœ… -22% |
| Low Priority | 5 | 6 | 6 | âž¡ï¸ Same |
| Source Files | ~30 | 25 | 26 | âž¡ï¸ |
| Lines of Code | ~3,500 | ~3,605 | ~8,000 | âž¡ï¸ (better counting) |
| `any` types | 15+ | 19+ | 30 | âš ï¸ (better detection) |
| Console.log | 18 | 2 | 13 | âš ï¸ (different counting) |
| Test coverage | 0% | 0% | 0% | âž¡ï¸ |
| .env.example | âŒ | âŒ | âœ… | âœ… Fixed |
| .eslintrc | âŒ | âŒ | âœ… | âœ… Fixed |
| Admin middleware | âŒ | âŒ | âœ… | âœ… Fixed |
| DB indexes | âŒ | âŒ | âœ… | âœ… Fixed |

**Overall Trend:** ðŸŸ¡ Mixed
- Dev tooling significantly improved (4 high-priority items resolved)
- New critical issue discovered (corrupted type file)
- Type safety and testing remain persistent debt
- Documentation needs attention (missing README)

---

## ðŸŽ¯ Recommendations for Next Audit (2026-02-24)

1. **Verify corrupted file is fixed:** Check `src/types/supabase.ts` is resolved
2. **README.md quality check:** Score the new README
3. **Type safety progress:** Track `any` type reduction (target: <20)
4. **Test coverage:** Check if any tests have been added
5. **`.DS_Store` cleanup:** Verify `.gitignore` updated
6. **Admin user edit:** Verify service role API route created
7. **Dependency updates:** Check for Supabase JS, OpenNext updates

---

## ðŸ“ Documentation Updates

### README.md
**Status:** Exists, comprehensive (527 lines) â€” needs minor updates
**Quality Score:** 8/10

**Strengths:**
- Thorough feature documentation
- Clear setup instructions with environment variables
- Super-admin configuration guide
- Contributing guidelines
- Well-structured project directory overview

**Issues Found:**
- Line 55: References `/history` page as functional (it returns 404)
- Line 145: References `test-session/[id]/route.ts` (file was deleted in audit #1)
- Missing reference to `.env.example` file
- Missing reference to `src/types/database.ts`
- Missing reference to `.eslintrc.json`
- Missing reference to `app/admin/middleware.ts`
- Version numbers slightly outdated (e.g., `@supabase/supabase-js` listed as v2.48, now v2.81)

**Recommended Updates:** Fix inaccurate references and add recently created files.

### CLAUDE.md
**Status:** âœ… Optimal (no changes needed)
**Line count:** 139 lines (well under 800-line target)
**Quality Score:** 9/10

**Strengths:**
- Concise and focused
- All sections current and accurate
- Well-organized structure
- Perfect length for AI context

**Minor note:** Could add reference to corrupted `src/types/supabase.ts` in Known Gotchas once resolved.

---

**Audit completed:** 2026-02-17
**Next audit due:** 2026-02-24
